name: auto_assign_issue

on:
  issue_comment:
    types: [created]

permissions:
  issues: write

jobs:
  assign:
    if: >
      github.event.issue.pull_request == null &&
      (
        contains(toLower(github.event.comment.body), 'assign me') ||
        contains(toLower(github.event.comment.body), 'assign it to me')
      )
    runs-on: ubuntu-latest
    steps:
      - name: Assign commenter
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = context.payload.issue.number;
            const assignee = context.payload.comment.user.login;
            // 1) Don't reassign if already assigned
            const current = context.payload.issue.assignees?.map(a => a.login) || [];
            if (current.length > 0) {
              core.info(`Already assigned to: ${current.join(', ')}`);
              return;
            }
            // 2) Block if label "blocked" exists (case-insensitive)
            const labels = (context.payload.issue.labels || []).map(l => (typeof l === 'string' ? l : l.name)).filter(Boolean);
            const hasBlockedLabel = labels.some(l => String(l).toLowerCase() === 'blocked');
            if (hasBlockedLabel) {
              await github.rest.issues.createComment({
                owner, repo, issue_number,
                body: `â›” Sorry @${assignee} â€” this issue is currently labeled **blocked**, so it canâ€™t be claimed yet.`
              });
              return;
            }
            // 3) Block if issue is blocked by other issues (Issue Dependencies)
            // Docs: GET /repos/{owner}/{repo}/issues/{issue_number}/dependencies/blocked_by :contentReference[oaicite:1]{index=1}
            let blockedByCount = 0;
            try {
              const res = await github.request(
                'GET /repos/{owner}/{repo}/issues/{issue_number}/dependencies/blocked_by',
                { owner, repo, issue_number, per_page: 1, page: 1 }
              );
              // This endpoint returns an array; treat any non-empty as "blocked by something"
              if (Array.isArray(res.data)) blockedByCount = res.data.length;
            } catch (e) {
              // If the repo/account doesnâ€™t have the feature enabled, or endpoint unavailable,
              // we fail OPEN (donâ€™t block claiming) but log it.
              core.info(`Could not check dependencies/blocked_by: ${e.message}`);
            }
            if (blockedByCount > 0) {
              await github.rest.issues.createComment({
                owner, repo, issue_number,
                body: `â›” Sorry @${assignee} â€” this issue is **blocked by another issue**, so it canâ€™t be claimed yet.`
              });
              return;
            }
            // 4) Assign
            await github.rest.issues.addAssignees({
              owner, repo, issue_number,
              assignees: [assignee],
            });
            await github.rest.issues.createComment({
              owner, repo, issue_number,
              body: `ðŸŽ‰ Thank you for your interest in contributing!\n\nâœ… The issue has been assigned to @${assignee}. Happy coding! ðŸš€`
            });
